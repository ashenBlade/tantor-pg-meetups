# Доклад

## Подготовка

Для настройки репозитория для доклада необходимо запустить скрипт `init_repo.sh`
из папки `./repo`.

Этот скрипт:

1. Скачает PostgreSQL 16.4
2. Применит к нему патч для настройки окружения к докладу
3. Скопирует скрипты для разработки
4. Если будет установлен VS Code:
    1. Скопирует файлы конфигурации в `.vscode`
    2. Установит необходимые расширения

> Для скачивания исходников необходимы `git` (предпочтительнее), либо `wget` +
> `tar`. Если они отсутствуют, то просьба скачать и установить файлы с исходным
> кодом в директорию `./repo/postgresql` и запустить скрипт заново (он обнаружит,
> что директория уже существует).

Для сборки и отладки необходимо установить:

- `libreadline`
- `bison`
- `flex`
- `make`
- `gcc`
- `gdb` (или другой отладчик)
- `CPAN` (для PERL)

Установить их можно:

```shell
# Debian based
sudo apt update
sudo apt install build-essential gdb bison flex libreadline-dev git

# RPM based
sudo yum update
sudo yum install gcc gdb bison flex make readline-devel perl-CPAN git

```

Ссылка на архивы с 16.4 версией - [https://ftp.postgresql.org/pub/source/v16.4](https://ftp.postgresql.org/pub/source/v16.4).

Настройку окружения можно произвести следующим образом (запуск не от root'а):

```shell
# Запускаем скрипт инициализации репозитория: скачивание файлов,
# применение патчей, установка расширений VS Code и т.д.
./init_repo.sh

# Переходим в директорию с исходным кодом
cd postgresql

# Запускаем сборку (параллельно 8 воркеров, можно убрать)
./dev/build.sh -j 8

# Настраиваем схему БД
./dev/run.sh --init-db --run-db --psql --script=../schema_constrexcl.sql --stop-db

# Запускаем VS Code и открываем необходимые вкладки (если есть)
code . --goto src/backend/optimizer/util/constrexcl.c  \
        --goto src/backend/optimizer/util/clauses.c    \
        --goto src/backend/optimizer/plan/planmain.c
```

> Если при установке произошла ошибка, можно запустить установку полностью
> заново передав флаг `-f` скрипту `init_repo.sh`: `./init_repo.sh -f`.

После этого можно запускать PSQL и выполнять скрипты из `queries_constrexcl.sql`.

Работа будет производиться в файлах (можно открыть предварительно):

- `src/backend/optimizer/util/constrexcl.c`
- `src/backend/optimizer/util/clauses.c`
- `src/backend/optimizer/plan/planmain.c`

> Если VS Code установлен ПОСЛЕ запуска скрипта настройки, то следует скопировать
> директорию `.vscode` в директорию с файлами БД (`postgresql`) вручную:
> `cp -r .vscode postgresql/.vscode`. В ней находятся файлы конфигурации для
> VS Code.

## Инструментарий

В директории `dev` находятся скрипты автоматизации разработки PostgreSQL:

- `setup.sh` - настройка окружения для разработки: запуск `./configure`,
    создание файлов конфигурации и др. Он запускается 1 раз, перед началом
    разработки.
- `build.sh` - скрипт для запуска сборки
- `run.sh` - скрипт для управления БД и запуска PSQL
- `test.sh` - запуск тестов
- `clean.sh` - очистка репозитория после работы

> Также имеются инфраструктурные скрипты: `get_current_backend_pid.sh`,
> `utils.sh`. Но их лучше не трогать самостоятельно.

У каждого есть опции `-h`/`--help` для отображения информации по каждому.

Эти скрипты должны лежать в директории `dev` в корне проекта (корень исходников
PostgreSQL).

Для VS Code имеются файлы конфигурации: `tasks.json`, `launch.json` и
`c_cpp_properties.json`. Они содержат вспомогательные настройки для IDE -
таски, конфигурации отладчика и т.д.

Таски VS Code можно просмотреть через выпадающее окно тасок с помощью команды
`Tasks: Run Task` (командная панель), либо непосредственно в файле
`.vscode/tasks.json`.

## Автоматизация рутины

Для автоматизации работы используются скрипты. Краткое введение в скрипты:

1. Запускаем `./dev/setup.sh` когда только приступили к работе, либо удалили
  предыдущие созданные файлы (начинаем заново)
2. Делаем изменения в коде
3. Запускаем сборку БД через `./dev/build.sh`
4. Запускаем тесты через `./dev/test.sh --regress` - проверяем, что ничего не
   сломали
5. Создаем и запускаем БД - `./dev/run.sh --init-db --run-db`
6. Запускаем PSQL - `./dev/run.sh --psql`
7. Ставим где нужно точки останова, запускаем отладчик (F5) и вводим PID нашего
   бэкэнда (высветился в PSQL)
8. Запускаем скрипт, дебажим, завершаем работу, делаем изменения, опять собираем
9. После работы можно очистить созданные файлы - `./dev/clean.sh --build`

Также есть множество тасок для VS Code. Эти шаги можно выполнить с помощью тасок
следующим образом:

1. Запускаем таску `Setup` для настройки окружения
2. Делаем изменения в коде
3. Запускаем сборку БД через таску `Build`, либо сочетанием клавиш `Ctrl + Shift + B`
4. Запускаем тесты через таску `Test regress`, либо сочетанием клавиш `Ctrl + Shift + T`
5. Создаем и запускаем БД - таска `Run DB`
6. Запускаем PSQL - таска `Run psql`
7. Ставим где нужно точки останова, запускаем отладчик (F5) и вводим PID нашего
   бэкэнда (высветился в PSQL)
8. Запускаем скрипт, дебажим, завершаем работу, делаем изменения, опять собираем
9. После работы можно очистить созданные файлы - таска `Clean build`

> Для ускорения запуска тасок можно забиндить команду `Tasks: Run Task`.
> Например, `Alt + T`. После этого, можно запускать нужные таски быстрее

## Задачи

Перед выполнением советуется установить расширение
[PostgreSQL Hacker Helper](https://marketplace.visualstudio.com/items?itemName=ash-blade.postgresql-hacker-helper)
для более удобной работы с планировщиком.

### Исследование планировщика

В файле `queries_constraint_exclusion.sql` находятся SQL команды: настройка
схемы и запросы для тестирования работы планировщика.



Поставьте точку останова на ... и т.д. - TODO

Вопросы:

- ...
- ...
- ...

### Улучшение оптимизации

В файле `0001-Constraint-Optimization.patch` находится последний патч для
оптимизации Constraint Optimization. Необходимо доработать его следующим:

- Сравнение не только с атрибутами, но и функциями
- Обнаружение перестановок узлов - когда константа находится слева, а не справа
- Нахождение конфликтующих условий не зависимо от их местоположения - в текущей
  реализации обнаруживаются только рядом стоящие
- Нахождение условий в OR (дерево целое условий) - (xxx OR xxx AND yyy) OR zzz

### Исследование схем

Тут надо выполнить теже запросы, что и у меня в схемах, но измененные и надо
сказать что изменилось.

Например, в Range Table немного изменить порядок JOIN'ов - как изменится массив
`simple_rte_array`
