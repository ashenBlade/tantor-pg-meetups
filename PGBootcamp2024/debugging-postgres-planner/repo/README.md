# Лабы

## Подготовка

В данной папке находятся скрипты автоматизации разработки:

- `setup.sh` - настройка окружения для разработки: запуск `./configure`,
    создание файлов конфигурации и др. Он запускается 1 раз, перед началом
    разработки.
- `build.sh` - скрипт для запуска сборки
- `run.sh` - скрипт для управления БД и запуска PSQL
- `test.sh` - запуск тестов
- `clean.sh` - очистка репозитория после работы

> Также имеются инфраструктурные скрипты: `get_current_backend_pid.sh`, 
> `utils.sh`.

У каждого есть опции `-h`/`--help` для отображения информации по каждому.

Для VS Code имеются файлы конфигурации: `tasks.json`, `launch.json` и
`c_cpp_properties.json`. Они содержат вспомогательные настройки для IDE -
таски, конфигурации отладчика и т.д.

Также имеется скрипт `init_repo.sh`. Он скачает PostgreSQL в директорию
`postgresql`, скопирует скрипты для разработки в папку `dev` и файлы
конфигурации VS Code в `.vscode` (внутри `postgresql`). После этого можно
приступать к разработке.

Можно настроить и любой другой репозиторий - все `.sh` файлы скопировать в папку
`dev` (в корне проекта), а `*.json` - в `.vscode`. Предполагается, что все
скрипты находятся в папке `dev` в корне, на этом завязана некоторая логика
работы.

## Автоматизация рутины

Для автоматизации работы используются скрипты. Краткое введение в скрипты:

1. Запускаем `./dev/setup.sh` когда только приступили к работе, либо удалили
  предыдущие созданные файлы (начинаем заново)
2. Делаем изменения в коде
3. Запускаем сборку БД через `./dev/build.sh`
4. Запускаем тесты через `./dev/test.sh --regress` - проверяем, что ничего не
   сломали
5. Создаем и запускаем БД - `./dev/run.sh --init-db --run-db`
6. Запускаем PSQL - `./dev/run.sh --psql` и подключаемся к бэкэнду
7. Ставим где нужно точки останова и запускаем отладчик (F5) - он сразу
   присоединяется к бэкэнду
8. Запускаем скрипт, дебажим, завершаем работу, делаем изменения, опять собираем
9. После работы можно очистить созданные файлы - `./dev/clean.sh --build`

Также есть множество тасок для VS Code

Заметки:

- Сборку и тесты можно запускать через комбинации Ctrl + Shift + B и Ctrl +
  Shift + T соответственно (комбинации клавиш по умолчанию)
- Для поддержки быстрого подключения к бэкэнду необходимо расширение
  [Tasks Shell Input](https://marketplace.visualstudio.com/items?itemName=augustocdias.tasks-shell-input)

## Задачи

Перед выполнение советуется установить расширение
[PostgreSQL Hacker Helper](https://marketplace.visualstudio.com/items?itemName=ash-blade.postgresql-hacker-helper)
для более удобной работы.

### Исследование планировщика

Исследуем основные структуры планировщика. В начале необходимо создать схему бд:

```sql
CREATE TABLE tbl1(
    id BIGINT GENERATED ALWAYS AS IDENTITY, 
    value INTEGER
);

CREATE TABLE tbl2(
    id BIGINT GENERATED ALWAYS AS IDENTITY, 
    tbl1_id INTEGER REFERENCES tbl1(id),
    value TEXT
);
```

Поставьте точку останова на ... и т.д. - TODO

Вопросы:

- ...
- ...
- ...

### Улучшение оптимизации

В файле `0001-Constraint-Optimization.patch` находится последний патч для
оптимизации Constraint Optimization. Необходимо доработать его следующим:

- Сравнение не только с атрибутами, но и функциями
- Обнаружение перестановок узлов - когда константа находится слева, а не справа
- Нахождение конфликтующих условий не зависимо от их местоположения - в текущей
  реализации обнаруживаются только рядом стоящие
- Нахождение условий в OR (дерево целое условий) - (xxx OR xxx AND yyy) OR zzz
