# Речь
## Титульник

Всем привет. Меня зовут Сергей Соловьев. Я разработчик в компании Тантор. 
Разрабатываю одноименную СУБД.
Сегодня я расскажу об отладке планировщика.

## Обработка запроса

Для начала вспомним о пайплайне обработки запроса. В нем 4 этапа: парсинг
строки запроса, переписывание, планировние и выполнение.

Нам сегодня интересн 3 этап - планирование. Именно здесь и работает планировщик.

В его работе можно также выделить 4 этапа.

Первый этап - предобработка дерева запроса. На этом этапе выполняются общие 
оптимизации. Например, вычисление константных выражений.

Далее идет оптимизация. Здесь инициализируется состояние планировщика и 
применяются более серьезные оптимизации. Например, удаление ненужных JOIN'ов.

После, когда все оптимизации выполнены находятся все возможные пути выполнения.
Например, в каждом запросе всегда возможен путь последовательного сканирования,
но также можно добавить и путь, использующий индекс.

Последний этап - выбор наиболее дешевого пути из созданных и создание для него
плана выполнения.

## Функции исходного кода

Говоря об исходном коде, можно выделить несколько основных функций и разграничить
эти этапы между ними.

На схеме справа можно заметить части запроса и функции, которые ответственны за эти
области. Используем bottom-up подход.

query\_planner - планировщик обхода таблиц. Он создает все scan узлы: SeqScan, 
    IndexScan и другие. При необходимости, он запускает планировщики для других
    подзапросов.

grouping\_planner - это обертка над query\_planner, которая добавляет разного
    рода обработку базового запроса: сортировка, группировка, лимиты/офсеты.
    Можно сказать, это реализация паттерна декоратор

subquery\_planner - это планировщик одного подзапроса. Причем, верхнеуровневный
    запрос - это тоже подзапрос, просто без родителя. Даже если у вас нет явных
    подзапросов, то весь запрос - это один большой подзапрос.

standard\_planner - входная точка всего планировщика. Он вызывает 
    subquery\_planner для верхнеуровнего запроса и дальше рекурсивно запускается
    для каждого подзапроса.

Слева тоже почти тоже самое, но добавлены комментарии что ДО и ПОСЛЕ функции.

## Узлы

Другая тема - структуры данных. 



## Структуры планировщика

## Идея оптимизации

## Лайв-кодинг

## Советы

## Расширение

## Конец
